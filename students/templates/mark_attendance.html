{% extends 'base.html' %}
{% block title %}Mark Attendance - {{ department.name }}{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h3 class="mb-0">Mark Attendance</h3>
      <small class="text-muted">Department: <strong>{{ department.name }}</strong></small>
    </div>
    <div>
      <a href="{% url 'teacher_dashboard' %}" class="btn btn-sm btn-outline-secondary">Back to Dashboard</a>
    </div>
  </div>

  <!-- Alert placeholder -->
  <div id="att-alert" class="alert d-none" role="alert"></div>

  <!-- Date + form -->
  <form id="attendance-form" class="card p-3 shadow-sm">
    {% csrf_token %}
    <div class="row g-3 align-items-center mb-3">
      <div class="col-auto">
        <label for="att_date" class="form-label mb-0">Date</label>
      </div>
      <div class="col-auto">
        <input id="att_date" name="date" type="date" class="form-control" value="{{ today }}" required>
      </div>
    </div>

    <!-- Students table -->
    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th style="width:1%">#</th>
            <th>Student</th>
            <th>Username</th>
            <th style="width:1%">Present</th>
          </tr>
        </thead>
        <tbody>
          {% for s in students %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td>{{ s.user.get_full_name }}</td>
              <td>{{ s.user.username }}</td>
              <td class="text-center">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="present_{{ s.id }}" name="present_{{ s.id }}">
                </div>
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="4" class="text-center text-muted">No students in this department.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="d-flex gap-2 mt-3">
      <button id="save-att" type="button" class="btn btn-primary">
        <span id="save-spinner" class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true"></span>
        Save Attendance (AJAX)
      </button>

      <button id="save-back" type="button" class="btn btn-outline-primary">Save & Back</button>

      <button type="reset" class="btn btn-outline-secondary ms-auto">Reset</button>
    </div>
  </form>
</div>

<script>
  // get CSRF cookie (Django)
  function getCookie(name){
    let v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return v ? v.pop() : '';
  }

  // helpers to show alert
  const alertEl = document.getElementById('att-alert');
  function showAlert(message, type='success'){
    alertEl.className = 'alert alert-' + type;
    alertEl.textContent = message;
    alertEl.classList.remove('d-none');
    // auto-hide after 4s
    setTimeout(()=> alertEl.classList.add('d-none'), 4000);
  }

  function setSaving(isSaving){
    const btn = document.getElementById('save-att');
    const spinner = document.getElementById('save-spinner');
    if(isSaving){
      btn.disabled = true;
      spinner.classList.remove('d-none');
    } else {
      btn.disabled = false;
      spinner.classList.add('d-none');
    }
  }

  // gather present_* fields and post
  function postAttendance(redirectAfter=false){
    const dateInput = document.getElementById('att_date').value;
    if(!dateInput){
      showAlert('Please pick a date.', 'warning');
      return;
    }

    const formData = new FormData();
    formData.append('date', dateInput);
    formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));

    // append each present checkbox if checked
    {% for s in students %}
      (function(){
        const el = document.querySelector('input[name="present_{{ s.id }}"]');
        if(el && el.checked){
          formData.append('present_{{ s.id }}', 'on');
        }
      })();
    {% endfor %}

    setSaving(true);

    fetch(window.location.href, {
      method: 'POST',
      body: formData,
      credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
      setSaving(false);
      if(data.status === 'ok'){
        showAlert('Attendance saved successfully.', 'success');
        if(redirectAfter){
          // small delay to let user see success
          setTimeout(()=> { window.location = "{% url 'teacher_dashboard' %}"; }, 700);
        }
      } else {
        showAlert('Error: ' + (data.message || 'Unknown error'), 'danger');
      }
    })
    .catch(err => {
      console.error(err);
      setSaving(false);
      showAlert('Network error saving attendance.', 'danger');
    });
  }

  document.getElementById('save-att').addEventListener('click', function(){ postAttendance(false); });
  document.getElementById('save-back').addEventListener('click', function(){ postAttendance(true); });
</script>
{% endblock %}
